' Classe: DefinirLimitesEixoVertCommand
Option Explicit

Public Sub Execute(nomeGrafico As Variant)

    Dim grafico As Chart
    Dim valorMinimo As Double, valorMaximo As Double
    Dim limiteInferior As Double, limiteSuperior As Double
    Dim media As Double, x As Double
    Dim serie As Series
    Dim i As Long
    
    ' Obtém o gráfico pelo nome
    Set grafico = Config.ws.ChartObjects(nomeGrafico).Chart

    ' Inicializa valores extremos
    valorMinimo = 10
    valorMaximo = -10

    'Encontra min e max em todas as séries
    For Each serie In grafico.SeriesCollection
        For i = 1 To serie.Points.Count
            If serie.Values(i) < valorMinimo Then valorMinimo = serie.Values(i)
            If serie.Values(i) > valorMaximo Then valorMaximo = serie.Values(i)
        Next i
    Next serie

    'Calcula x
    media = (valorMaximo + valorMinimo) / 2
    x = Application.WorksheetFunction.Max(valorMaximo - media, media - valorMinimo)
    
    'Calcula limites
    limiteInferior = media - x
    limiteSuperior = media + x
    
    limiteInferior = PadronizarCasaDecimal(limiteInferior, "min")
    limiteSuperior = PadronizarCasaDecimal(limiteSuperior, "max")

    'Defini limites do eixo vertical
    grafico.Axes(xlValue).MinimumScale = limiteInferior
    grafico.Axes(xlValue).MaximumScale = limiteSuperior
End Sub

'Ajusta o valor para casa decimal com 0 ou 5
Private Function PadronizarCasaDecimal(limite As Double, tipoLim As String) As Double
    Dim parteInteira As Long
    Dim parteDecimal As Double
    
    parteInteira = Int(limite)
    parteDecimal = limite - parteInteira

    If parteDecimal < 0.49 Then
            PadronizarCasaDecimal = parteInteira
    ElseIf parteDecimal < 0.5 Then
        PadronizarCasaDecimal = parteInteira + 0.5
    Else
        If tipoLim = "max" Then
            PadronizarCasaDecimal = parteInteira + 1
        ElseIf tipoLim = "min" Then
            PadronizarCasaDecimal = parteInteira
        End If
    End If
End Function
